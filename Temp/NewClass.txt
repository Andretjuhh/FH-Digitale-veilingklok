              var jwtSettings =
                configuration.GetSection(JwtConfiguration.Key).Get<JwtConfiguration>()
                ?? throw CustomException.JwtConfigurationMissing();
  
  services
      .AddAuthentication(options =>
      {
          options.DefaultAuthenticateScheme = JwtBearerDefaults.AuthenticationScheme;
          options.DefaultChallengeScheme = JwtBearerDefaults.AuthenticationScheme;
      })
      .AddJwtBearer(options =>
      {
          // Store in HttpContext for later retrieval
          options.SaveToken = true;

          options.TokenValidationParameters = new TokenValidationParameters
          {
              // This is where the framework reads the configuration to validate tokens
              ValidateIssuer = true,
              ValidateAudience = true,
              ValidateLifetime = true,
              ValidateIssuerSigningKey = true,

              // Settings from appsettings.json
              ValidIssuer = jwtSettings.Issuer,
              ValidAudience = jwtSettings.Audience,
              IssuerSigningKey = new SymmetricSecurityKey(
                  Encoding.UTF8.GetBytes(jwtSettings.Secret)
              ),
          };
      });